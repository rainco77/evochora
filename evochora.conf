# Evochora Data Pipeline Configuration
# This is the main configuration file for the Evochora data pipeline.
# It defines the services and channels that make up the pipeline.

pipeline {
  # Auto-start configuration
  autoStart = true
  startupSequence = [environment-state-indexer, "simulation-engine", "debug-server"]

  metrics {
      enableMetrics = true
      updateIntervalSeconds = 3
  }
  
  # Channel definitions - message transport mechanisms between services
  channels {
    raw-tick-data {
      className = "org.evochora.datapipeline.channels.InMemoryChannel"
      options {
        capacity = 10000  # High capacity for tick data
      }
    }
    context-data {
      className = "org.evochora.datapipeline.channels.InMemoryChannel"
      options {
        capacity = 1000  # Lower capacity for context data (sent once)
      }
    }
  }
  
  # Service definitions - the actual processing components
  services {
    #dummy-consumer {
    #  className = "org.evochora.datapipeline.services.DummyConsumerService"
    #  inputs = ["simulation-context"]
    #}
    
    #debug-indexer {
    #  className = "org.evochora.datapipeline.services.debugindexer.DebugIndexerService"
    #  inputs = ["raw-tick-data", "context-data"]
    #  options {
    #    # Debug indexer specific configuration
    #    # debugDbPath will be auto-generated with timestamp: runs/sim_run_YYYYMMDD_HHMMSS_debug.sqlite
    #    batchSize = 1000
    #    
    #    # Database optimization settings
    #    database {
    #      synchronous = "NORMAL"
    #      cacheSize = 10000
    #    }
    #    
    #    # Memory optimization settings
    #    memoryOptimization {
    #      enabled = true
    #    }
    #    
    #    # Compression settings (must match debug-server)
    #    compression {
    #      enabled = false
    #    }
    #  }
    #}
    
    simulation-engine {
      className = "org.evochora.datapipeline.services.SimulationEngine"
      outputs {
        tickData: "raw-tick-data"
        contextData: "context-data"
      }
      options {
        environment {
          shape = [100, 100]  # 10,000 cells world
          topology = "TORUS"
        }
        organisms = [{
          program = "assembly/primordial/main.s"
          initialEnergy = 30000
          placement {
            positions = [5, 5]
          }
        }]
        energyStrategies = [{
          className = "org.evochora.runtime.worldgen.GeyserCreator"
          options {
            count = 5
            interval = 100
            amount = 50
            safetyRadius = 3
          }
        }, {
          className = "org.evochora.runtime.worldgen.SolarRadiationCreator"
          options {
            probability = 0.05
            amount = 25
            safetyRadius = 2
            executionsPerTick = 1
          }
        }]
        pauseTicks = [10000, 90000]  # Auto-pause at these ticks
      }
    }
    debug-server {
      className = "org.evochora.datapipeline.services.http.DebugServerService"
      options {
        port = 8080
        dbPath = "runs"  # Directory - will automatically use the newest SQLite file
        compression {
          enabled = false
          algorithm = "gzip"
        }
      }
    }
    
  environment-state-indexer {
    className = "org.evochora.datapipeline.services.indexer.EnvironmentStateIndexerService"
    inputs {
      tickData: "raw-tick-data"
      contextData: "context-data"
    }
    options {
      batchSize = 1000
      batchTimeoutMs = 5000
      storage = "environment-storage"
    }
  }
  }
  
  # ===================================================================
  #  STORAGE CONFIGURATION
  #  Definiert, welche Datenbank-Implementierung für die gesamte
  #  Pipeline verwendet werden soll.
  # ===================================================================
  storage {
    environment-storage {
      className = "org.evochora.datapipeline.storage.impl.h2.H2SimulationRepository"
      options {
        # Der JDBC-URL ist die zentrale Einstellung für H2. Er steuert den Modus und den Speicherort.
        #
        # --- Option 1: Dateibasiert (persistent) ---
        # Speichert die Datenbank in einer Datei im Unterverzeichnis 'evochora_data'.
        # Die Daten bleiben nach einem Neustart der Anwendung erhalten.
        # './' bedeutet, der Pfad ist relativ zum Arbeitsverzeichnis der Anwendung.
        jdbcUrl = "jdbc:h2:file:./evochora_data/environment_states_{simulationRunId}"

        # --- Option 2: In-Memory (flüchtig, am schnellsten) ---
        # Die Datenbank existiert nur im Arbeitsspeicher und ist nach dem Beenden weg.
        # Ideal für schnelle Tests oder wenn die Daten nicht dauerhaft gespeichert werden müssen.
        # DB_CLOSE_DELAY=-1 verhindert, dass die DB beim Schließen der letzten Verbindung gelöscht wird.
        # jdbcUrl = "jdbc:h2:mem:environmentdb;DB_CLOSE_DELAY=-1"

        # Standard-Benutzername und Passwort für H2
        user = "sa"
        password = ""

        # Wenn 'true', erstellt das Repository beim ersten Start automatisch alle
        # benötigten Tabellen und Indizes. Das ist extrem nutzerfreundlich.
        # Im produktiven Einsatz könnte man dies auf 'false' setzen und
        # die Migration mit einem separaten Tool steuern.
        initializeSchema = true
      
        
        # ===================================================================
        # H2 WEB CONSOLE KONFIGURATION
        # Aktiviert die eingebaute H2 Web Console für Datenbank-Debugging
        # ===================================================================
        webConsole {
          # Aktiviert/deaktiviert die H2 Web Console
          enabled = true
          
          # Port für die Web Console (Standard: 8082)
          port = 8083
          
          # Erlaubt externe Verbindungen (nur localhost wenn false)
          allowOthers = false
        }
      }
    }
  }
}

# Logging configuration
logging {
  format = "PLAIN"  # Can be "PLAIN" or "JSON". Defaults to PLAIN for interactive, JSON for headless.
  default-level = "INFO"  # Default log level for all loggers
  levels {
    # Specific logger levels - override the default for particular components
    "org.evochora.datapipeline.core.ServiceManager" = "INFO"
  }
}
