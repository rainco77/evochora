# Evochora Data Pipeline Configuration with Universal DI
# This is the main configuration file for the Evochora data pipeline.
# It defines the resources and services that make up the pipeline.

pipeline {
  # Auto-start configuration
  autoStart = true
  startupSequence = ["simulation-engine"]

  metrics {
      enableMetrics = true
      updateIntervalSeconds = 3
  }

  # Central resource definitions - all shared components (channels, storage, etc.)
  resources {
    raw-tick-data {
      className = "org.evochora.datapipeline.resources.InMemoryChannel"
      options {
        capacity = 10000  # High capacity for tick data
      }
    }
    context-data {
      className = "org.evochora.datapipeline.resources.InMemoryChannel"
      options {
        capacity = 1000  # Lower capacity for context data (sent once)
      }
    }

    # Example storage resource
    main-database {
      className = "org.evochora.datapipeline.resources.storage.H2SimulationRepository"
      options {
        jdbcUrl = "jdbc:h2:./runs/simulation.db;AUTO_SERVER=TRUE"
        username = "sa"
        password = ""
      }
    }
  }
  
  # Service definitions - the actual processing components
  services {
    #dummy-consumer {
    #  className = "org.evochora.datapipeline.services.DummyConsumerService"
    #  resources {
    #    messages = "channel-in:raw-tick-data"
    #  }
    #}

    #debug-indexer {
    #  className = "org.evochora.datapipeline.services.debugindexer.DebugIndexerService"
    #  resources {
    #    tickInput = "channel-in:raw-tick-data"
    #    contextInput = "channel-in:context-data"
    #    database = "storage-readwrite:main-database"
    #  }
    #  options {
    #    # Debug indexer specific configuration
    #    # debugDbPath will be auto-generated with timestamp: runs/sim_run_YYYYMMDD_HHMMSS_debug.sqlite
    #    batchSize = 1000
    #    
    #    # Database optimization settings
    #    database {
    #      synchronous = "NORMAL"
    #      cacheSize = 10000
    #    }
    #    
    #    # Memory optimization settings
    #    memoryOptimization {
    #      enabled = true
    #    }
    #    
    #    # Compression settings (must match debug-server)
    #    compression {
    #      enabled = false
    #    }
    #  }
    #}
    
    simulation-engine {
      className = "org.evochora.datapipeline.services.SimulationEngine"
      resources {
        # Universal DI resource URIs with usage types
        tickData = "channel-out:raw-tick-data"
        contextData = "channel-out:context-data"
      }
      options {
        environment {
          shape = [100, 100]  # 10,000 cells world
          topology = "TORUS"
        }
        organisms = [{
          program = "assembly/primordial/main.s"
          initialEnergy = 30000
          placement {
            positions = [5, 5]
          }
        }]
        energyStrategies = [{
          className = "org.evochora.runtime.worldgen.GeyserCreator"
          options {
            count = 5
            interval = 100
            amount = 50
            safetyRadius = 3
          }
        }, {
          className = "org.evochora.runtime.worldgen.SolarRadiationCreator"
          options {
            probability = 0.05
            amount = 25
            safetyRadius = 2
            executionsPerTick = 1
          }
        }]
        pauseTicks = [20000, 90000]  # Auto-pause at these ticks
      }
    }
    #debug-server {
    #  className = "org.evochora.datapipeline.services.http.DebugServerService"
    #  options {
    #    port = 8080
    #    dbPath = "runs"  # Directory - will automatically use the newest SQLite file
    #    compression {
    #      enabled = false
    #      algorithm = "gzip"
    #    }
    #  }
    #}
    
  #environment-state-indexer {
  #  className = "org.evochora.datapipeline.services.indexer.EnvironmentStateIndexerService"
  #  resources {
  #    tickData = "channel-in:raw-tick-data"
  #    contextData = "channel-in:context-data"
  #    storage = "storage-readwrite:main-database"
  #  }
  #  options {
  #    batchSize = 1000
  #    batchTimeoutMs = 1000
  #  }
  #}
  }
}
}

# Logging configuration
logging {
  format = "PLAIN"  # Can be "PLAIN" or "JSON". Defaults to PLAIN for interactive, JSON for headless.
  default-level = "INFO"  # Default log level for all loggers
  levels {
    # Specific logger levels - override the default for particular components
    "org.evochora.datapipeline.core.ServiceManager" = "INFO"
  }
}
