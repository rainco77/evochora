pipeline {
  # Automatically start services in startupSequence when ServiceManager initializes
  # Set to false for manual control via API (useful for development/testing)
  autoStart = true  # default: true

  startupSequence = ["consumer", "producer"]

  resources {
    test-queue {
      className = "org.evochora.datapipeline.resources.queues.InMemoryBlockingQueue"
      options {
        capacity = 1000
        throughputWindowSeconds = 5
      }
    }

    consumer-dlq {
      className = "org.evochora.datapipeline.resources.queues.InMemoryDeadLetterQueue"
      options {
        capacity = 100
        primaryQueueName = "test-queue"
      }
    }

    consumer-idempotency-tracker {
      className = "org.evochora.datapipeline.resources.idempotency.InMemoryIdempotencyTracker"
      options {
        ttlSeconds = 3600
        cleanupThresholdMessages = 100
        cleanupIntervalSeconds = 60
      }
    }
  }

  services {
    consumer {
      className = "org.evochora.datapipeline.services.DummyConsumerService"
      resources {
        input = "queue-in:test-queue"
        idempotencyTracker = "tracker:consumer-idempotency-tracker"
        dlq = "queue-out:consumer-dlq"
      }
      options {
        processingDelayMs = 50
        maxMessages = 100
      }
    }

    producer {
      className = "org.evochora.datapipeline.services.DummyProducerService"
      resources {
        output = "queue-out:test-queue?window=2"
      }
      options {
        intervalMs = 100
        maxMessages = 100
      }
    }
  }
}

logging {
  format = "PLAIN"  # Can be "PLAIN" or "JSON". Defaults to JSON
  default-level = "INFO"  # Default log level for all loggers
  levels {
    # Specific logger levels - override the default for particular components
    "org.evochora.datapipeline.ServiceManager" = "INFO"
  }
}

# The node block configures the server process itself
node {
  # Show ASCII art welcome message on startup (default: false)
  show-welcome-message = true
  
  # Defines all long-running processes the Node should start and manage
  processes {

    # Logical name for the HTTP server process
    http {
      className = "org.evochora.node.processes.http.HttpServerProcess"
      options {
        network {
          host = "0.0.0.0"
          port = 8080

          # Optional: Configure the Jetty thread pool for HTTP request handling
          # Threads are named "<processName>-http-<number>" for easier monitoring
          threadPool {
            minThreads = 8         # Minimum number of threads (default: 8)
            maxThreads = 200       # Maximum number of threads (default: 200)
            idleTimeoutMs = 60000  # Idle timeout in milliseconds (default: 60000)
          }
        }

        # All routes are defined within the HttpServerProcess's options
        routes {
          # The nesting of objects defines the URL paths.
          # Actions ($controller, $static) are defined by keys prefixed with '$'.
          pipeline {
            # ACTION: Serves static UI files at the base path "/pipeline"
            # The static file handler serves from the classpath. A directory named
            # 'web/pipeline-control' should exist in 'src/main/resources'.
            #"$static" = "/web/pipeline-control"

            # Builds the sub-path "/pipeline/api"
            api {
              # ACTION: Serves a controller at "/pipeline/api"
              "$controller" {
                className = "org.evochora.node.processes.http.api.pipeline.PipelineController"
                options {}
              }
            }
          }
        }
      }
    }
  }
}