# Evochora Data Pipeline Configuration
# This is the main configuration file for the Evochora data pipeline.
# It defines the services and channels that make up the pipeline.

pipeline {
  # Auto-start configuration
  autoStart = true
  startupSequence = ["simulation-engine", "debug-indexer"]

  metrics {
      enableMetrics = true
      updateIntervalSeconds = 1
  }
  
  # Channel definitions - message transport mechanisms between services
  channels {
    simulation-context {
      className = "org.evochora.datapipeline.channels.InMemoryChannel"
      options {
        capacity = 100000  # High capacity for tick data
      }
    }
    #raw-tick-stream {
    #  className = "org.evochora.datapipeline.channels.InMemoryChannel"
    #  options {
    #    capacity = 10000  # High capacity for tick data
    #  }
    #}
  }
  
  # Service definitions - the actual processing components
  services {
    #dummy-consumer {
    #  className = "org.evochora.datapipeline.services.DummyConsumerService"
    #  inputs = ["simulation-context"]
    #}
    
    debug-indexer {
      className = "org.evochora.datapipeline.services.debugindexer.DebugIndexerService"
      inputs = ["simulation-context"]
      options {
        # Debug indexer specific configuration
        # debugDbPath will be auto-generated with timestamp: runs/sim_run_YYYYMMDD_HHMMSS_debug.sqlite
        batchSize = 100
        
        # Database optimization settings
        database {
          synchronous = "NORMAL"
          cacheSize = 10000
        }
        
        # Memory optimization settings
        memoryOptimization {
          enabled = true
        }
      }
    }
    
    simulation-engine {
      className = "org.evochora.datapipeline.services.SimulationEngine"
      #outputs = ["simulation-context", "raw-tick-stream"]
      outputs = ["simulation-context"]
      options {
        environment {
          shape = [100, 100]  # 10,000 cells world
          topology = "TORUS"
        }
        organisms = [{
          program = "assembly/primordial/main.s"
          initialEnergy = 1000
          placement {
            positions = [50, 50]  # Center of world
          }
        }]
        energyStrategies = [{
          className = "org.evochora.runtime.worldgen.GeyserCreator"
          options {
            count = 5
            interval = 100
            amount = 50
            safetyRadius = 3
          }
        }, {
          className = "org.evochora.runtime.worldgen.SolarRadiationCreator"
          options {
            probability = 0.05
            amount = 25
            safetyRadius = 2
            executionsPerTick = 1
          }
        }]
        pauseTicks = [90000]  # Auto-pause at these ticks
      }
    }
  }
}

# Logging configuration
logging {
  format = "PLAIN"  # Can be "PLAIN" or "JSON". Defaults to PLAIN for interactive, JSON for headless.
  default-level = "INFO"  # Default log level for all loggers
  levels {
    # Specific logger levels - override the default for particular components
    "org.evochora.datapipeline.core.ServiceManager" = "INFO"
  }
}
