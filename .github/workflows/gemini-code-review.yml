name: Gemini Code Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  code-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetches all history for git diff

      - name: Get PR diff
        id: pr_diff
        run: |
          diff=$(git diff origin/${{ github.base_ref }}...HEAD)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$diff" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Setup Gemini CLI
        uses: google-github-actions/run-gemini-cli@v0.1.15
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}

      - name: Generate Review Comment
        id: review
        env:
          # Pass the diff as an environment variable to prevent syntax errors
          PR_DIFF: ${{ steps.pr_diff.outputs.diff }}
        run: |
          # Safely construct the prompt in a temporary file
          cat << 'EOT' > prompt.txt
          You are an expert Java developer. Please act as a code reviewer. Review the following code changes for potential bugs, style violations, and improvements. Focus on correctness, clarity, and adherence to best practices. Provide constructive feedback. The code diff is:

          ```diff
          EOT
          
          echo "$PR_DIFF" >> prompt.txt
          echo '```' >> prompt.txt

          # Generate the review from the file and capture the output
          REVIEW_COMMENT=$(gemini chat --file prompt.txt)
          
          # Make the comment available to the next step
          echo "comment<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW_COMMENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post Review Comment
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${{ steps.review.outputs.comment }}`
            })
