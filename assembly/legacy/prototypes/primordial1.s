# Evochora "Hello‑World Organism" — Dynamic Hull Replicator (PoC)
# ---------------------------------------------------------------
# Aktualisiert auf die neue ISA‑Syntax (LR‑Ops mit %LRx, VSTR etc.).
# Legt zudem zur Compile‑Zeit eine STRUCTURE‑Hülle für den Eltern-
# organismus an (.PLACE), damit FIND_NW zuverlässig funktioniert.
#
# Layout: Der Code ist auf mehrere Zeilen verteilt via .ORG.
# Die Hülle umschließt das gesamte Programm (Innenfläche W×H).
#
# ---------------------------------------------------------------

# ===== Konstanten =====
.DEFINE GAP     DATA:3       # horizontaler Abstand zur Elternhülle
.DEFINE ENTRY_X DATA:1       # Entry‑Offset (x) relativ zur NW‑Innenzelle
.DEFINE ENTRY_Y DATA:0       # Entry‑Offset (y) relativ zur NW‑Innenzelle
.DEFINE SEED_ER ENERGY:2000  # Starteinlage für das Kind

# ===== Register‑Aliase =====
.REG %VAL   %DR0   # zuletzt gescannter Molekül‑Wert (Typ/Wert erhalten)
.REG %W     %DR1   # gemessene Innenbreite
.REG %SX    %DR2   # horizontale Verschiebung für Kind (W + GAP)
.REG %TMP   %DR3   # temporär / Zähler / Flag erste Zeile
.REG %OFF   %DR4   # Vektor: IP − NW (Entry‑Offset im Körper)
.REG %CH    %DR5   # Vektor: Kind‑Entry absolut (für FORK)
.REG %DV    %DR6   # Vektor: DV des Kindes (z. B. +x)
.REG %STRUC %DR7   # STRUCTURE‑Literal zum POKEn

# ===== Layout (globale Richtung) =====
.DIR 1|0

# ===== Eltern‑Hülle (Compile‑Zeit) =====
# Wir setzen die NW‑Innenzelle als (0|0) am folgenden ORG.
# Die Shell wird relativ dazu platziert: Top (y=-1), Bottom (y=H),
# Left (x=-1), Right (x=W).
# Innenfläche: W=120, H=20.

.ORG 300|300
.PLACE STRUCTURE:1 -1|-1
.PLACE STRUCTURE:1 0|-1
.PLACE STRUCTURE:1 1|-1
.PLACE STRUCTURE:1 2|-1
.PLACE STRUCTURE:1 3|-1
.PLACE STRUCTURE:1 4|-1
.PLACE STRUCTURE:1 5|-1
.PLACE STRUCTURE:1 6|-1
.PLACE STRUCTURE:1 7|-1
.PLACE STRUCTURE:1 8|-1
.PLACE STRUCTURE:1 9|-1
.PLACE STRUCTURE:1 10|-1
.PLACE STRUCTURE:1 11|-1
.PLACE STRUCTURE:1 12|-1
.PLACE STRUCTURE:1 13|-1
.PLACE STRUCTURE:1 14|-1
.PLACE STRUCTURE:1 15|-1
.PLACE STRUCTURE:1 16|-1
.PLACE STRUCTURE:1 17|-1
.PLACE STRUCTURE:1 18|-1
.PLACE STRUCTURE:1 19|-1
.PLACE STRUCTURE:1 20|-1
.PLACE STRUCTURE:1 21|-1
.PLACE STRUCTURE:1 22|-1
.PLACE STRUCTURE:1 23|-1
.PLACE STRUCTURE:1 24|-1
.PLACE STRUCTURE:1 25|-1
.PLACE STRUCTURE:1 26|-1
.PLACE STRUCTURE:1 27|-1
.PLACE STRUCTURE:1 28|-1
.PLACE STRUCTURE:1 29|-1
.PLACE STRUCTURE:1 30|-1
.PLACE STRUCTURE:1 31|-1
.PLACE STRUCTURE:1 32|-1
.PLACE STRUCTURE:1 33|-1
.PLACE STRUCTURE:1 34|-1
.PLACE STRUCTURE:1 35|-1
.PLACE STRUCTURE:1 36|-1
.PLACE STRUCTURE:1 37|-1
.PLACE STRUCTURE:1 38|-1
.PLACE STRUCTURE:1 39|-1
.PLACE STRUCTURE:1 40|-1
.PLACE STRUCTURE:1 41|-1
.PLACE STRUCTURE:1 42|-1
.PLACE STRUCTURE:1 43|-1
.PLACE STRUCTURE:1 44|-1
.PLACE STRUCTURE:1 45|-1
.PLACE STRUCTURE:1 46|-1
.PLACE STRUCTURE:1 47|-1
.PLACE STRUCTURE:1 48|-1
.PLACE STRUCTURE:1 49|-1
.PLACE STRUCTURE:1 50|-1
.PLACE STRUCTURE:1 51|-1
.PLACE STRUCTURE:1 52|-1
.PLACE STRUCTURE:1 53|-1
.PLACE STRUCTURE:1 54|-1
.PLACE STRUCTURE:1 55|-1
.PLACE STRUCTURE:1 56|-1
.PLACE STRUCTURE:1 57|-1
.PLACE STRUCTURE:1 58|-1
.PLACE STRUCTURE:1 59|-1
.PLACE STRUCTURE:1 60|-1
.PLACE STRUCTURE:1 61|-1
.PLACE STRUCTURE:1 62|-1
.PLACE STRUCTURE:1 63|-1
.PLACE STRUCTURE:1 64|-1
.PLACE STRUCTURE:1 65|-1
.PLACE STRUCTURE:1 66|-1
.PLACE STRUCTURE:1 67|-1
.PLACE STRUCTURE:1 68|-1
.PLACE STRUCTURE:1 69|-1
.PLACE STRUCTURE:1 70|-1
.PLACE STRUCTURE:1 71|-1
.PLACE STRUCTURE:1 72|-1
.PLACE STRUCTURE:1 73|-1
.PLACE STRUCTURE:1 74|-1
.PLACE STRUCTURE:1 75|-1
.PLACE STRUCTURE:1 76|-1
.PLACE STRUCTURE:1 77|-1
.PLACE STRUCTURE:1 78|-1
.PLACE STRUCTURE:1 79|-1
.PLACE STRUCTURE:1 80|-1
.PLACE STRUCTURE:1 81|-1
.PLACE STRUCTURE:1 82|-1
.PLACE STRUCTURE:1 83|-1
.PLACE STRUCTURE:1 84|-1
.PLACE STRUCTURE:1 85|-1
.PLACE STRUCTURE:1 86|-1
.PLACE STRUCTURE:1 87|-1
.PLACE STRUCTURE:1 88|-1
.PLACE STRUCTURE:1 89|-1
.PLACE STRUCTURE:1 90|-1
.PLACE STRUCTURE:1 91|-1
.PLACE STRUCTURE:1 92|-1
.PLACE STRUCTURE:1 93|-1
.PLACE STRUCTURE:1 94|-1
.PLACE STRUCTURE:1 95|-1
.PLACE STRUCTURE:1 96|-1
.PLACE STRUCTURE:1 97|-1
.PLACE STRUCTURE:1 98|-1
.PLACE STRUCTURE:1 99|-1
.PLACE STRUCTURE:1 100|-1
.PLACE STRUCTURE:1 101|-1
.PLACE STRUCTURE:1 102|-1
.PLACE STRUCTURE:1 103|-1
.PLACE STRUCTURE:1 104|-1
.PLACE STRUCTURE:1 105|-1
.PLACE STRUCTURE:1 106|-1
.PLACE STRUCTURE:1 107|-1
.PLACE STRUCTURE:1 108|-1
.PLACE STRUCTURE:1 109|-1
.PLACE STRUCTURE:1 110|-1
.PLACE STRUCTURE:1 111|-1
.PLACE STRUCTURE:1 112|-1
.PLACE STRUCTURE:1 113|-1
.PLACE STRUCTURE:1 114|-1
.PLACE STRUCTURE:1 115|-1
.PLACE STRUCTURE:1 116|-1
.PLACE STRUCTURE:1 117|-1
.PLACE STRUCTURE:1 118|-1
.PLACE STRUCTURE:1 119|-1
.PLACE STRUCTURE:1 120|-1
.PLACE STRUCTURE:1 -1|20
.PLACE STRUCTURE:1 0|20
.PLACE STRUCTURE:1 1|20
.PLACE STRUCTURE:1 2|20
.PLACE STRUCTURE:1 3|20
.PLACE STRUCTURE:1 4|20
.PLACE STRUCTURE:1 5|20
.PLACE STRUCTURE:1 6|20
.PLACE STRUCTURE:1 7|20
.PLACE STRUCTURE:1 8|20
.PLACE STRUCTURE:1 9|20
.PLACE STRUCTURE:1 10|20
.PLACE STRUCTURE:1 11|20
.PLACE STRUCTURE:1 12|20
.PLACE STRUCTURE:1 13|20
.PLACE STRUCTURE:1 14|20
.PLACE STRUCTURE:1 15|20
.PLACE STRUCTURE:1 16|20
.PLACE STRUCTURE:1 17|20
.PLACE STRUCTURE:1 18|20
.PLACE STRUCTURE:1 19|20
.PLACE STRUCTURE:1 20|20
.PLACE STRUCTURE:1 21|20
.PLACE STRUCTURE:1 22|20
.PLACE STRUCTURE:1 23|20
.PLACE STRUCTURE:1 24|20
.PLACE STRUCTURE:1 25|20
.PLACE STRUCTURE:1 26|20
.PLACE STRUCTURE:1 27|20
.PLACE STRUCTURE:1 28|20
.PLACE STRUCTURE:1 29|20
.PLACE STRUCTURE:1 30|20
.PLACE STRUCTURE:1 31|20
.PLACE STRUCTURE:1 32|20
.PLACE STRUCTURE:1 33|20
.PLACE STRUCTURE:1 34|20
.PLACE STRUCTURE:1 35|20
.PLACE STRUCTURE:1 36|20
.PLACE STRUCTURE:1 37|20
.PLACE STRUCTURE:1 38|20
.PLACE STRUCTURE:1 39|20
.PLACE STRUCTURE:1 40|20
.PLACE STRUCTURE:1 41|20
.PLACE STRUCTURE:1 42|20
.PLACE STRUCTURE:1 43|20
.PLACE STRUCTURE:1 44|20
.PLACE STRUCTURE:1 45|20
.PLACE STRUCTURE:1 46|20
.PLACE STRUCTURE:1 47|20
.PLACE STRUCTURE:1 48|20
.PLACE STRUCTURE:1 49|20
.PLACE STRUCTURE:1 50|20
.PLACE STRUCTURE:1 51|20
.PLACE STRUCTURE:1 52|20
.PLACE STRUCTURE:1 53|20
.PLACE STRUCTURE:1 54|20
.PLACE STRUCTURE:1 55|20
.PLACE STRUCTURE:1 56|20
.PLACE STRUCTURE:1 57|20
.PLACE STRUCTURE:1 58|20
.PLACE STRUCTURE:1 59|20
.PLACE STRUCTURE:1 60|20
.PLACE STRUCTURE:1 61|20
.PLACE STRUCTURE:1 62|20
.PLACE STRUCTURE:1 63|20
.PLACE STRUCTURE:1 64|20
.PLACE STRUCTURE:1 65|20
.PLACE STRUCTURE:1 66|20
.PLACE STRUCTURE:1 67|20
.PLACE STRUCTURE:1 68|20
.PLACE STRUCTURE:1 69|20
.PLACE STRUCTURE:1 70|20
.PLACE STRUCTURE:1 71|20
.PLACE STRUCTURE:1 72|20
.PLACE STRUCTURE:1 73|20
.PLACE STRUCTURE:1 74|20
.PLACE STRUCTURE:1 75|20
.PLACE STRUCTURE:1 76|20
.PLACE STRUCTURE:1 77|20
.PLACE STRUCTURE:1 78|20
.PLACE STRUCTURE:1 79|20
.PLACE STRUCTURE:1 80|20
.PLACE STRUCTURE:1 81|20
.PLACE STRUCTURE:1 82|20
.PLACE STRUCTURE:1 83|20
.PLACE STRUCTURE:1 84|20
.PLACE STRUCTURE:1 85|20
.PLACE STRUCTURE:1 86|20
.PLACE STRUCTURE:1 87|20
.PLACE STRUCTURE:1 88|20
.PLACE STRUCTURE:1 89|20
.PLACE STRUCTURE:1 90|20
.PLACE STRUCTURE:1 91|20
.PLACE STRUCTURE:1 92|20
.PLACE STRUCTURE:1 93|20
.PLACE STRUCTURE:1 94|20
.PLACE STRUCTURE:1 95|20
.PLACE STRUCTURE:1 96|20
.PLACE STRUCTURE:1 97|20
.PLACE STRUCTURE:1 98|20
.PLACE STRUCTURE:1 99|20
.PLACE STRUCTURE:1 100|20
.PLACE STRUCTURE:1 101|20
.PLACE STRUCTURE:1 102|20
.PLACE STRUCTURE:1 103|20
.PLACE STRUCTURE:1 104|20
.PLACE STRUCTURE:1 105|20
.PLACE STRUCTURE:1 106|20
.PLACE STRUCTURE:1 107|20
.PLACE STRUCTURE:1 108|20
.PLACE STRUCTURE:1 109|20
.PLACE STRUCTURE:1 110|20
.PLACE STRUCTURE:1 111|20
.PLACE STRUCTURE:1 112|20
.PLACE STRUCTURE:1 113|20
.PLACE STRUCTURE:1 114|20
.PLACE STRUCTURE:1 115|20
.PLACE STRUCTURE:1 116|20
.PLACE STRUCTURE:1 117|20
.PLACE STRUCTURE:1 118|20
.PLACE STRUCTURE:1 119|20
.PLACE STRUCTURE:1 120|20
.PLACE STRUCTURE:1 -1|0
.PLACE STRUCTURE:1 -1|1
.PLACE STRUCTURE:1 -1|2
.PLACE STRUCTURE:1 -1|3
.PLACE STRUCTURE:1 -1|4
.PLACE STRUCTURE:1 -1|5
.PLACE STRUCTURE:1 -1|6
.PLACE STRUCTURE:1 -1|7
.PLACE STRUCTURE:1 -1|8
.PLACE STRUCTURE:1 -1|9
.PLACE STRUCTURE:1 -1|10
.PLACE STRUCTURE:1 -1|11
.PLACE STRUCTURE:1 -1|12
.PLACE STRUCTURE:1 -1|13
.PLACE STRUCTURE:1 -1|14
.PLACE STRUCTURE:1 -1|15
.PLACE STRUCTURE:1 -1|16
.PLACE STRUCTURE:1 -1|17
.PLACE STRUCTURE:1 -1|18
.PLACE STRUCTURE:1 -1|19
.PLACE STRUCTURE:1 120|0
.PLACE STRUCTURE:1 120|1
.PLACE STRUCTURE:1 120|2
.PLACE STRUCTURE:1 120|3
.PLACE STRUCTURE:1 120|4
.PLACE STRUCTURE:1 120|5
.PLACE STRUCTURE:1 120|6
.PLACE STRUCTURE:1 120|7
.PLACE STRUCTURE:1 120|8
.PLACE STRUCTURE:1 120|9
.PLACE STRUCTURE:1 120|10
.PLACE STRUCTURE:1 120|11
.PLACE STRUCTURE:1 120|12
.PLACE STRUCTURE:1 120|13
.PLACE STRUCTURE:1 120|14
.PLACE STRUCTURE:1 120|15
.PLACE STRUCTURE:1 120|16
.PLACE STRUCTURE:1 120|17
.PLACE STRUCTURE:1 120|18
.PLACE STRUCTURE:1 120|19

# ===== Programmcode innerhalb der Eltern‑Innenfläche =====
# ENTRY liegt bei (1|0) relativ zur NW‑Innenzelle.
SETI %STRUC STRUCTURE:1

# Zeile 0 (y=0): ENTRY
.ORG 1|0
ENTRY:
  SYNC                    # DP0 := IP
  CALL FIND_NW            # finde NW‑Innenzelle, setze LR0 & LR1
  CALL MEASURE_WIDTH      # misst Breite (bis rechter STRUCTURE), setzt %W und %SX
  CALL POSITION_DP1       # DP1 = an LR1 (links vom Kind‑NW) + SX nach rechts
  CALL COPY_ROWS_WITH_SHELL  # zeilenweises Kopieren + Shell links/rechts + Top/Bottom
  CALL FORK_CHILD         # Kind starten
  JMPI ENTRY              # optional: erneut versuchen

# Zeile 1 (y=1): FIND_NW
.ORG 1|1
FIND_NW:
  # In aktueller Zeile nach ganz links (bis links STRUCTURE anliegt)
LEFT_SEEK_ROW:
  SCNI %VAL -1|0
  IFTI %VAL STRUCTURE:1
  JMPI LEFT_DONE
  SEKI -1|0
  JMPI LEFT_SEEK_ROW
LEFT_DONE:
  # Jetzt Zeile für Zeile nach oben, jeweils erst ganz nach links ziehen
UP_ROWS:
  SCNI %VAL 0|-1
  IFTI %VAL STRUCTURE:1
  JMPI NW_LOCK
  SEKI 0|-1
  JMPI LEFT_SEEK_ROW
NW_LOCK:
  DPLR %LR0           # LR0 := NW (innen)
  SEKI -1|0           # eine links = linke Rand‑Pos
  DPLR %LR1           # LR1 := linke Rand‑Pos
  SKLR %LR0           # zurück auf NW‑Innen
  RET

# Zeile 2 (y=2): MEASURE_WIDTH
.ORG 1|2
MEASURE_WIDTH:
  ADPI DATA:0
  SKLR %LR1
  SETI %W  DATA:0
MEAS_LOOP:
  SCNI %VAL 1|0
  IFTI %VAL STRUCTURE:1
  JMPI MEAS_DONE
  ADDI %W DATA:1
  SEKI 1|0
  JMPI MEAS_LOOP
MEAS_DONE:
  SETI %SX GAP
  ADDR %SX %W
  RET

# Zeile 3 (y=3): POSITION_DP1
.ORG 1|3
POSITION_DP1:
  ADPI DATA:1
  SKLR %LR1
  SETR %TMP %SX
POS_DP1_SHIFT:
  GTI %TMP DATA:0
  JMPI POS_DP1_STEP
  JMPI POS_DP1_DONE
POS_DP1_STEP:
  SEKI 1|0
  SUBI %TMP DATA:1
  JMPI POS_DP1_SHIFT
POS_DP1_DONE:
  ADPI DATA:0
  RET

# Zeile 4 (y=4): COPY_ROWS_WITH_SHELL
.ORG 1|4
COPY_ROWS_WITH_SHELL:
  # DP0 := LR1 (Eltern‑linke Rand‑Pos), DP1 steht bereits am Kind‑linken Rand
  ADPI DATA:0
  SKLR %LR1

  # Flag „erste Zeile“ setzen
  SETI %TMP DATA:1

ROW_LOOP:
  # — Top‑Shell nur einmal zeichnen —
  GTI %TMP DATA:0             # if TMP > 0 → erste Zeile
  JMPI DRAW_TOP_SHELL
  JMPI SKIP_TOP
DRAW_TOP_SHELL:
  ADPI DATA:1                 # DP1 (Kind)
  SEKI 0|-1                   # eine nach oben
  # (W + 2) STRUCTURE: linkshell + innen + rechtshell
  SETR %TMP %W                # Zähler N = W + 2
  ADDI %TMP DATA:2
TOP_SHELL_LOOP:
  POKI %STRUC 0|0             # schreibe auf aktuelle Zelle
  SUBI %TMP DATA:1
  GTI %TMP DATA:0
  JMPI TOP_SHELL_STEP
  JMPI TOP_SHELL_DONE
TOP_SHELL_STEP:
  SEKI 1|0                    # nach rechts gehen
  JMPI TOP_SHELL_LOOP
TOP_SHELL_DONE:
  SEKI 0|1                    # wieder nach unten auf Innen‑Zeile
  # DP1 robust neu ausrichten (links vom Kind‑NW)
  ADPI DATA:0
  CALL POSITION_DP1
  ADPI DATA:0
  SETI %TMP DATA:0            # Flag löschen
SKIP_TOP:

  # — Linke Shell dieser Zeile setzen —
  ADPI DATA:1
  POKI %STRUC 0|0             # genau auf Rand‑Pos (linke Shell)
  ADPI DATA:0

COL_LOOP:
  SCNI %VAL 1|0               # Innenzelle inspizieren
  IFTI %VAL STRUCTURE:1
  JMPI ROW_END                # rechts Hülle → Zeile beendet
  # Innenzelle auf Kind schreiben (+1|0)
  ADPI DATA:1
  POKI %VAL 1|0
  ADPI DATA:0
  # beide DPs einen Schritt nach rechts
  ADPI DATA:0
  SEKI 1|0
  ADPI DATA:1
  SEKI 1|0
  ADPI DATA:0
  JMPI COL_LOOP

ROW_END:
  # — Rechte Shell am Zeilenende setzen (an DP1+1|0) —
  ADPI DATA:1
  POKI %STRUC 1|0

  # Beide DPs bis zur linken Hülle zurückspulen
REWIND_LEFT:
  ADPI DATA:0
  SCNI %VAL -1|0
  IFTI %VAL STRUCTURE:1
  JMPI REWIND_DONE
  ADPI DATA:0
  SEKI -1|0
  ADPI DATA:1
  SEKI -1|0
  JMPI REWIND_LEFT
REWIND_DONE:
  # Eine Zeile nach unten (für beide)
  ADPI DATA:0
  SEKI 0|1
  ADPI DATA:1
  SEKI 0|1
  ADPI DATA:0

  # Abbruchtest: ist die erste Innenzelle der neuen Zeile Hülle?
  SCNI %VAL 1|0
  IFTI %VAL STRUCTURE:1
  JMPI AFTER_LAST_ROW         # unten Hülle → Bottom‑Shell zeichnen
  JMPI ROW_LOOP

AFTER_LAST_ROW:
  # — Bottom‑Shell über (W + 2) Zellen zeichnen —
  ADPI DATA:1                 # DP1 steht auf linker Rand‑Pos der „Hüllen‑Zeile“
  SETR %TMP %W
  ADDI %TMP DATA:2
BOTTOM_SHELL_LOOP:
  POKI %STRUC 0|0
  SUBI %TMP DATA:1
  GTI %TMP DATA:0
  JMPI BOTTOM_SHELL_STEP
  JMPI BOTTOM_SHELL_DONE
BOTTOM_SHELL_STEP:
  SEKI 1|0
  JMPI BOTTOM_SHELL_LOOP
BOTTOM_SHELL_DONE:
  ADPI DATA:0
  RET

# Zeile 5 (y=5): FORK_CHILD
.ORG 1|5
FORK_CHILD:
  # OFF = IP − NW
  ADPI DATA:0
  SKLR %LR0
  DIFF %OFF
  SETV %CH 0|0
  SUBR %CH %OFF
  SETR %OFF %CH

  # %CH := Kind‑NW = (aktuelle DP1‑linke Rand‑Pos der letzten Zeile)
  ADPI DATA:1
  DPLR %LR2                 # LR2 := aktuelle DP1 (linke Rand‑Pos)
  LRDR %CH %LR2
  # +1|0 in die Innenzelle
  SETV %DV 1|0
  ADDR %CH %DV
  # + ENTRY‑Offset (ENTRY_X/Y) per VSTR (Index und Wert aus Registern)
  SETV %DV 0|0
  SETI %TMP DATA:0           # Index 0 (x)
  SETI %VAL ENTRY_X          # Wert für x
  VSTR %DV %TMP %VAL
  SETI %TMP DATA:1           # Index 1 (y)
  SETI %VAL ENTRY_Y          # Wert für y
  VSTR %DV %TMP %VAL
  ADDR %CH %DV
  # + (IP − NW)
  ADDR %CH %OFF

  # Kind‑DV = +x
  SETV %DV 1|0

  # FORK
  SETI %TMP SEED_ER
  FORK %CH %TMP %DV
  RET