version: '3.8'
services:
  evochora:
    build:
      context: ../../..  # Gehe drei Ebenen hoch zum Projekt-Root
      dockerfile: infrastructure/docker/evochora-node/Dockerfile # Pfad zum Dockerfile
    image: ghcr.io/rainco77/evochora:${IMAGE_TAG:-latest}
    user: "${UID:-1000}:${GID:-1000}"
    ports:
      # Map host ports to container ports
      - "80:8081"      # Javalin Web UI (Extern: 80 -> Intern: 8081)
      - "8082:8082"    # H2 Web Console (Extern: 8082 -> Intern: 8082)
      - "9092:9092"    # H2 TCP Server (Extern: 9092 -> Intern: 9092)
    volumes:
      # Mount host directories into the container for persistent data
      - ./evochora-data/storage:/home/appuser/app/data/storage
      - ./evochora-data/database:/home/appuser/app/data/database
      # Mount the configuration file into the container's config directory (read-only)
      - ./evochora.conf:/home/appuser/app/config/evochora.conf:ro
    environment:
      # === Steuerung des Anwendungs-Verhaltens ===
      - PIPELINE_AUTOSTART=false

      # === JVM Options & Konfigurations-Overrides via System Properties (-D) ===
      # Dies ist die zuverlässigste Methode, da System Properties die höchste Priorität
      # in der Konfigurations-Lade-Kette der Anwendung haben.
      - >
        JAVA_OPTS=
        -Xmx16g
        -Dslf4j.replay.warn=false
        -Dlogging.format=JSON
        -Dnode.processes.http.options.network.host=0.0.0.0
        -Dnode.processes.h2-console.options.network.host=0.0.0.0
        -Dnode.processes.h2-tcp-server.options.tcpAllowOthers=true
        -Dpipeline.database.jdbcUrl="jdbc:h2:/home/appuser/app/data/database/indexdb;MODE=PostgreSQL;DB_CLOSE_ON_EXIT=FALSE;DB_CLOSE_DELAY=-1;CACHE_SIZE=262144;LOCK_TIMEOUT=10000"
        -Dpipeline.resources.tick-storage.options.rootDirectory="/home/appuser/app/data/storage"
        -Dpipeline.resources.batch-topic.options.jdbcUrl="jdbc:h2:/home/appuser/app/data/database/topicdb;MODE=PostgreSQL;DB_CLOSE_ON_EXIT=FALSE;DB_CLOSE_DELAY=-1;CACHE_SIZE=262144;LOCK_TIMEOUT=10000"
        -Dnode.processes.h2-console.options.database.jdbcUrl="jdbc:h2:/home/appuser/app/data/database/indexdb;MODE=PostgreSQL;DB_CLOSE_ON_EXIT=FALSE;DB_CLOSE_DELAY=-1;CACHE_SIZE=262144"
        -Dnode.processes.h2-tcp-server.options.database.jdbcUrl="jdbc:h2:/home/appuser/app/data/database/indexdb;MODE=PostgreSQL;DB_CLOSE_ON_EXIT=FALSE;DB_CLOSE_DELAY=-1;CACHE_SIZE=262144"

    restart: unless-stopped
