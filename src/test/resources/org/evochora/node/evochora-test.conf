# Test configuration for the Node integration test.
# It uses a different port to avoid conflicts with the main application.

# The pipeline configuration is minimal, just enough to test the API.
pipeline {
  autoStart = false
  startupSequence = [] # No services started by default in this test

  resources {
    test-queue {
      className = "org.evochora.datapipeline.resources.queues.InMemoryBlockingQueue"
      options {
        capacity = 10
      }
    }

    test-consumer-dlq {
      className = "org.evochora.datapipeline.resources.queues.InMemoryDeadLetterQueue"
      options {
        capacity = 50
        primaryQueueName = "test-queue"
      }
    }

    test-idempotency-tracker {
      className = "org.evochora.datapipeline.resources.idempotency.InMemoryIdempotencyTracker"
      options {
        ttlSeconds = 3600
        cleanupThresholdMessages = 100
        cleanupIntervalSeconds = 60
      }
    }
  }

  services {
    test-consumer {
      className = "org.evochora.datapipeline.services.DummyConsumerService"
      resources {
        input = "queue-in:test-queue"
        idempotencyTracker = "tracker:test-idempotency-tracker"
        dlq = "queue-out:test-consumer-dlq"
      }
    }
    test-producer {
      className = "org.evochora.datapipeline.services.DummyProducerService"
      resources {
        output = "queue-out:test-queue"
      }
      options {
        intervalMs = 1000 # Slow down for testing
      }
    }
  }
}

# The node block configures the server process for the test.
node {
  processes {
    httpServer {
      className = "org.evochora.node.processes.http.HttpServerProcess"
      options {
        network {
          host = "127.0.0.1"
          port = 8081 # Use a dedicated test port
        }
        routes {
          pipeline {
            api {
              "$controller" {
                className = "org.evochora.node.processes.http.api.pipeline.PipelineController"
                options {}
              }
            }
          }
        }
      }
    }
  }
}

logging {
  level = "INFO"
}