# ================================================
# Prototyp: InstructionTester.s
# Beschreibung: Testet alle Kern-Instruktionen.
# Entspricht 1:1 dem ursprünglichen Java-Prototypen.
# ================================================

# --- Register-Definitionen ---
.REG %DR_A 0
.REG %DR_B 1
.REG %DR_C 2
.REG %DR_RESULT 3
.REG %VEC_RIGHT 4
.REG %VEC_LEFT 5
.REG %VEC_DOWN 6

# --- Makro-Definitionen ---
.MACRO $ASSERT_LITERAL REGISTER EXPECTED_LITERAL
    SETI %DR_RESULT DATA:1         # Annahme: Test schlägt fehl (Ergebnis 1)
    IFI REGISTER EXPECTED_LITERAL
    SETI %DR_RESULT DATA:0         # Test erfolgreich (Ergebnis 0)
    SEEK %VEC_LEFT
    POKE %DR_RESULT %VEC_LEFT
.ENDM

.MACRO $ASSERT_REG REGISTER_A REGISTER_B
    SETI %DR_RESULT DATA:1         # Annahme: Test schlägt fehl
    IFR REGISTER_A REGISTER_B
    SETI %DR_RESULT DATA:0         # Test erfolgreich
    SEEK %VEC_LEFT
    POKE %DR_RESULT %VEC_LEFT
.ENDM

# --- Programmstart & Initialisierung ---
# .ORG 0|0 wird durch Setup.java gesetzt, aber kann hier zur Klarheit stehen
START:
    SETV %VEC_RIGHT 1|0
    SETV %VEC_LEFT -1|0
    SETV %VEC_DOWN 0|1
    JMPI TEST_SETI

# --- TEST-KETTE ---

.ORG 3|1
.PLACE STRUCTURE:1 0|1
TEST_SETI:
    SYNC
    SETI %DR_A DATA:123
    $ASSERT_LITERAL %DR_A DATA:123
    JMPI TEST_SETR

.ORG 3|3
.PLACE STRUCTURE:2 0|3
TEST_SETR:
    SYNC
    SETI %DR_B DATA:456
    SETR %DR_A %DR_B
    $ASSERT_LITERAL %DR_A DATA:456
    JMPI TEST_SETV

.ORG 3|5
.PLACE STRUCTURE:3 0|5
TEST_SETV:
    SYNC
    SETV %DR_A TEST_VECTOR_TARGET
    SETV %DR_B 26|5
    $ASSERT_REG %DR_A %DR_B
TEST_VECTOR_TARGET:
    JMPI TEST_ADDR

.ORG 3|7
.PLACE STRUCTURE:4 0|7
TEST_ADDR:
    SYNC
    SETI %DR_A DATA:10
    SETI %DR_B DATA:20
    ADDR %DR_A %DR_B
    $ASSERT_LITERAL %DR_A DATA:30
    JMPI TEST_SUBR

.ORG 3|9
.PLACE STRUCTURE:5 0|9
TEST_SUBR:
    SYNC
    SETV %DR_A 5|5
    SETV %DR_B 1|2
    SUBR %DR_A %DR_B
    SETV %DR_C 4|3
    $ASSERT_REG %DR_A %DR_C
    JMPI TEST_NANDR

.ORG 3|11
.PLACE STRUCTURE:6 0|11
TEST_NANDR:
    SYNC
    SETI %DR_A DATA:5
    SETI %DR_B DATA:3
    NADR %DR_A %DR_B
    $ASSERT_LITERAL %DR_A DATA:-2
    JMPI TEST_PUSHPOP

.ORG 3|13
.PLACE STRUCTURE:7 0|13
TEST_PUSHPOP:
    SYNC
    SETI %DR_A DATA:999
    PUSH %DR_A
    SETI %DR_A DATA:0
    POP %DR_A
    $ASSERT_LITERAL %DR_A DATA:999
    JMPI TEST_JMP_ABSOLUTE

.ORG 3|15
.PLACE STRUCTURE:8 0|15
TEST_JMP_ABSOLUTE:
    SYNC
    SETV %DR_A JUMP_TARGET
    JMPR %DR_A
JUMP_FAIL:
    SETI %DR_RESULT DATA:1
    SEEK %VEC_LEFT
    POKE %DR_RESULT %VEC_LEFT
    JMPI TEST_DIFF
JUMP_TARGET:
    SETI %DR_RESULT DATA:0
    SEEK %VEC_LEFT
    POKE %DR_RESULT %VEC_LEFT
    JMPI TEST_DIFF

.ORG 3|17
.PLACE STRUCTURE:9 0|17
TEST_DIFF:
    SYNC
    SEEK %VEC_RIGHT
    DIFF %DR_A
    SETV %DR_B -1|0
    $ASSERT_REG %DR_A %DR_B
    JMPI TEST_POS

.ORG 3|19
.PLACE STRUCTURE:10 0|19
TEST_POS:
    SYNC
    NOP
    POS %DR_A
    SETV %DR_B 4|21
    $ASSERT_REG %DR_A %DR_B
    JMPI TEST_NRG

.ORG 3|21
.PLACE STRUCTURE:11 0|21
TEST_NRG:
    SYNC
    NRG %DR_A
    SETI %DR_RESULT DATA:1
    GTI %DR_A DATA:0
    SETI %DR_RESULT DATA:0
    SEEK %VEC_LEFT
    POKE %DR_RESULT %VEC_LEFT
    JMPI TEST_SCAN

.ORG 3|23
.PLACE STRUCTURE:12 0|23
TEST_SCAN:
    .PLACE DATA:777 3|24
    SYNC
    SCAN %DR_A %VEC_DOWN
    $ASSERT_LITERAL %DR_A DATA:777
    JMPI TEST_PEEK

.ORG 3|25
.PLACE STRUCTURE:13 0|25
TEST_PEEK:
    .PLACE ENERGY:50 3|26
    SYNC
    PEEK %DR_A %VEC_DOWN
    $ASSERT_LITERAL %DR_A ENERGY:50
    SCAN %DR_B %VEC_DOWN
    $ASSERT_LITERAL %DR_B CODE:0
    JMPI TEST_TURN

.ORG 3|27
.PLACE STRUCTURE:14 0|27
TEST_TURN:
    SYNC
    TURN %VEC_DOWN
    .DIR 0|1
    SETI %DR_RESULT DATA:0
    SEEK %VEC_LEFT
    POKE %DR_RESULT %VEC_LEFT
    TURN %VEC_RIGHT
    .DIR 1|0
    JMPI START